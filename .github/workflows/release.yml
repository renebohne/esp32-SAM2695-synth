# .github/workflows/release.yml

name: Create Release and Build Binaries

# This workflow runs when a new tag (starting with 'v') is pushed.
on:
  push:
    tags:
      - 'v*' # Triggers on tags like v1.0, v1.0.1, etc.

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      # 1. Check out the repository code
      - name: Check out repository
        uses: actions/checkout@v4

      # 2. Set up Python, which PlatformIO depends on
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3. Install PlatformIO Core
      - name: Install PlatformIO Core
        run: pip install platformio

      # 4. Install project library dependencies (from platformio.ini)
      - name: Install project libraries
        run: pio lib install
        working-directory: BLE  # Run in the directory with platformio.ini

      # 5. Build all environments from platformio.ini
      - name: Build PlatformIO Environments
        run: |
          pio run -e esp32s3
          pio run -e esp32c3
          pio run -e esp32c6
        working-directory: BLE  # Run in the directory with platformio.ini

      # 6. Package the compiled .bin files into a separate folder for upload
      #    We rename them to be unique for the release.
      - name: Package firmware binaries
        run: |
          mkdir -p release_assets
          cp .pio/build/esp32s3/firmware.bin ../release_assets/firmware-esp32s3.bin
          cp .pio/build/esp32c3/firmware.bin ../release_assets/firmware-esp32c3.bin
          cp .pio/build/esp32c6/firmware.bin ../release_assets/firmware-esp32c6.bin
        working-directory: BLE  # Run in the directory with platformio.ini

      # 7. Create the GitHub Release and upload the .bin files as assets
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          # Use the release_assets directory and all files in it
          files: release_assets/*
          
          # Use the tag name (e.g., "v1.0.0") as the release title
          name: Release ${{ github.ref_name }}
          
          # Set draft: true if you want to manually edit notes before publishing
          draft: false
          
          # Set prerelease: true if this is a pre-release
          prerelease: false
        env:
          # The GITHUB_TOKEN is automatically supplied by GitHub Actions
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}